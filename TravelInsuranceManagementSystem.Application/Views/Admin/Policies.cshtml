@model IEnumerable<TravelInsuranceManagementSystem.Application.Models.Policy>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Admin Policies";
}

<h2 class="mb-3">Global Policy Management</h2>

@* Filter Section *@
<div class="row g-2 mb-3">
    <div class="col-12 col-sm-6 col-lg-4">
        <select id="policyStatus" class="form-select">
            <option value="All">All Status</option>
            <option value="ACTIVE">Active</option>
            <option value="EXPIRED">Expired</option>
            <option value="CANCELLED">Cancelled</option>
        </select>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
        <input type="text" id="adminSearch" class="form-control" placeholder="Search by ID or Name...">
    </div>
</div>

<div class="table-responsive">
    <table id="policyTable" class="table table-hover align-middle mb-0 shadow-sm border">
        <thead class="table-light">
            <tr>
                <th>Policy ID</th>
                <th>Primary Member</th>
                <th>Country</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Plan</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var item in Model)
                {
                    // Logic to find the Primary member (usually the first one added)
                    var primaryMember = item.Members.FirstOrDefault();
                    var customerName = primaryMember != null ? $"{primaryMember.FirstName} {primaryMember.LastName}" : "N/A";

                    var statusBadge = item.PolicyStatus switch
                    {
                        TravelInsuranceManagementSystem.Application.Models.PolicyStatus.ACTIVE => "bg-success",
                        TravelInsuranceManagementSystem.Application.Models.PolicyStatus.EXPIRED => "bg-secondary",
                        TravelInsuranceManagementSystem.Application.Models.PolicyStatus.CANCELLED => "bg-danger",
                        _ => "bg-info"
                    };

                    <tr>
                        <td class="fw-bold">P-@item.PolicyId.ToString("D5")</td>
                        <td>@customerName</td>
                        <td>@item.DestinationCountry</td>
                        <td>@item.TravelStartDate.ToString("yyyy-MM-dd")</td>
                        <td>@item.TravelEndDate.ToString("yyyy-MM-dd")</td>
                        <td><span class="badge bg-primary">@item.CoverageType</span></td>
                        <td><span class="badge @statusBadge">@item.PolicyStatus</span></td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" class="text-center py-4">No records found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Live Search Logic
            $("#adminSearch").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#policyTable tbody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Status Filter Logic
            $("#policyStatus").on("change", function () {
                var value = $(this).val().toLowerCase();
                if(value === "all") {
                    $("#policyTable tbody tr").show();
                } else {
                    $("#policyTable tbody tr").filter(function () {
                        $(this).toggle($(this).find('td:last').text().toLowerCase().trim() === value);
                    });
                }
            });
        });
    </script>
}